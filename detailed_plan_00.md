# Детальный план реализации `task_description_00.md`

## 1. Цель и ожидаемый результат
Собрать веб-приложение на `TypeScript + HTML + CSS`, которое:
1. Показывает визуализатор из 12 секторов + внутренний круг со стрелкой.
2. Дает ввести целое число (включая отрицательное) для транспозиции в полутонах.
3. Проигрывает мелодию «Чижик-Пыжик» с учетом транспозиции.
4. Во время проигрывания подсвечивает текущую ноту в круге и рисует внешний сектор толщиной, пропорциональной длительности.
5. Корректно разворачивается на GitHub Pages.

## 2. Входные данные и принятые решения
1. Источник требований: `blueprint/task_description_00.md`.
2. Нотный источник: `blueprint/cp.abc`.
3. Визуальный ориентир: `blueprint/music_visualize.png`.
4. `cp.abc` будет преобразован в структуру `[(pitchClass, durationUnits)]` в коде (это явно допускается требованиями), без runtime-парсера ABC.
5. Повтор `|: ... :|` учитывается: фраза проигрывается 2 раза.

## 3. План работ по этапам

### Этап 1. Подготовка каркаса проекта
1. Создать минимальную структуру фронтенда:
   - `index.html`
   - `src/main.ts`
   - `src/styles.css`
   - `src/melody.ts`
   - `src/audio.ts`
   - `src/visualizer.ts`
2. Настроить сборку TypeScript (предпочтительно через Vite для простого GitHub Pages деплоя).
3. Добавить npm-скрипты: `dev`, `build`, `preview`, `deploy` (или шаги для ручного деплоя).

Результат этапа: приложение стартует локально, базовый UI отрисован.

### Этап 2. Модель данных мелодии и транспозиции
1. Описать типы:
   - `NoteEvent { pitchClass: number; durationUnits: number }`
   - `PlaybackNote { pitchClass: number; frequency: number; durationSec: number }`
2. Перевести `cp.abc` в массив событий в `melody.ts`.
3. Реализовать функцию транспозиции:
   - `(pitchClass + shift) mod 12` с корректной обработкой отрицательных сдвигов.
4. Реализовать конвертер длительностей в секунды через темп (например, 120 BPM, где `L:1/8` — базовая единица).

Результат этапа: корректный список нот для воспроизведения при любом целочисленном `shift`.

### Этап 3. Реализация визуализатора
1. Построить круг из 12 секторов (SVG как основной вариант: проще контролировать геометрию, подписи и анимации).
2. Подписать сектора нотами: `C, C#, D, D#, E, F, F#, G, G#, A, A#, B`.
3. Назначить цвета:
   - Натуральные: `C..B` как радуга (красный -> фиолетовый).
   - Диезы: аддитивное смешение соседних натуральных.
4. Добавить внутреннюю стрелку и логику поворота в зависимости от транспозиции (`shift mod 12`).
5. Добавить состояния:
   - `active sector` (когда нота звучит).
   - `outer duration ring`/сектор с толщиной, зависящей от длительности текущей ноты.

Результат этапа: визуализатор полностью отражает транспозицию и текущую ноту в проигрывании.

### Этап 4. Аудио-движок и синхронизация с UI
1. Использовать `Web Audio API` (`AudioContext`, `OscillatorNode`, `GainNode`).
2. На клик `Play`:
   - активировать/резюмировать `AudioContext` (учет autoplay-ограничений браузера),
   - собрать транспонированную последовательность,
   - запланировать ноты по времени.
3. Синхронизировать подсветку с фактическим временем старта/конца ноты.
4. На время проигрывания заблокировать повторный старт или реализовать корректный restart.

Результат этапа: слышимая мелодия и синхронная визуальная индикация.

### Этап 5. UI/UX и валидация
1. Поле ввода сделать `type="number"` с шагом `1` (вверх/вниз доступны нативно).
2. Обработать невалидные значения:
   - пустое значение -> `0`,
   - дробные значения -> округление или запрет (оставить только целые).
3. Добавить небольшие текстовые подсказки (например, «сдвиг в полутонах»).
4. Проверить адаптивность (desktop + мобильный).

Результат этапа: предсказуемое поведение интерфейса без ошибок ввода.

### Этап 6. Проверка и финализация
1. Ручные сценарии:
   - `shift = 0`, `+1`, `-1`, `+12`, `-12`, `+25`.
   - Визуальная стрелка соответствует ожидаемому сектору.
   - Подсветка совпадает с звучащей нотой.
2. Проверить, что длительные ноты визуально толще коротких.
3. Сборка production (`npm run build`) проходит без ошибок.
4. Деплой на GitHub Pages и smoke-check в браузере.

Результат этапа: рабочее приложение с выполнением всех пунктов задачи.

## 4. Потенциальные риски и как их закрываю
1. **Дрейф тайминга** при `setTimeout`: минимизировать через планирование в `AudioContext.currentTime`.
2. **Автозапуск звука блокируется**: старт аудио только по пользовательскому клику.
3. **Сложность геометрии секторов**: использовать SVG-пути и отдельные утилиты вычисления углов.
4. **Несовпадение цветов с эскизом**: зафиксировать палитру константами и проверить визуально.

## 5. Критерии готовности (Definition of Done)
1. Есть поле транспозиции (целые значения, включая отрицательные) и кнопка `Play`.
2. Стрелка во внутреннем круге корректно показывает позицию ноты `C` после транспозиции.
3. «Чижик-Пыжик» воспроизводится в правильных длительностях и транспозиции.
4. Во время звучания ноты подсвечивается нужный сектор и отображается внешний сектор с толщиной по длительности.
5. Приложение собрано и доступно через GitHub Pages.
