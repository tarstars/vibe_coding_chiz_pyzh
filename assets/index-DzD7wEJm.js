(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const c of n.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();const x=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function g(r,e){return(r%e+e)%e}function M(r){return 440*Math.pow(2,(r-69)/12)}function I(r){const e=r.replace("#",""),t=e.length===3?e.split("").map(s=>s+s):[e.slice(0,2),e.slice(2,4),e.slice(4,6)];return{r:Number.parseInt(t[0],16),g:Number.parseInt(t[1],16),b:Number.parseInt(t[2],16)}}function L(r,e,t){const s=i=>i.toString(16).padStart(2,"0");return`#${s(r)}${s(e)}${s(t)}`}function B(r,e){const t=I(r),s=I(e);return L(Math.round((t.r+s.r)/2),Math.round((t.g+s.g)/2),Math.round((t.b+s.b)/2))}class G{constructor(){this.audioContext=null,this.timerIds=[],this.oscillators=[],this.runToken=0,this.playing=!1}get isPlaying(){return this.playing}async play(e,t){var u;if(e.length===0){(u=t.onFinish)==null||u.call(t);return}await this.ensureContext(),this.clearScheduledAudio();const s=++this.runToken,i=this.audioContext;i.state==="suspended"&&await i.resume(),this.playing=!0;const c=i.currentTime+.06;for(const o of e){const l=c+o.startSec,d=l+o.durationSec,p=i.createOscillator();p.type="triangle",p.frequency.setValueAtTime(M(o.midi),l);const m=i.createGain(),O=Math.min(.02,o.durationSec*.3);m.gain.setValueAtTime(1e-4,l),m.gain.exponentialRampToValueAtTime(.2,l+O),m.gain.exponentialRampToValueAtTime(1e-4,d),p.connect(m),m.connect(i.destination),p.start(l),p.stop(d+.01),this.oscillators.push(p);const v=Math.max(0,(l-i.currentTime)*1e3),E=Math.max(0,(d-i.currentTime)*1e3);this.timerIds.push(window.setTimeout(()=>{var y;s===this.runToken&&((y=t.onNoteStart)==null||y.call(t,o))},v)),this.timerIds.push(window.setTimeout(()=>{var y;s===this.runToken&&((y=t.onNoteEnd)==null||y.call(t,o))},E))}const h=(c+e[e.length-1].startSec+e[e.length-1].durationSec-i.currentTime)*1e3;this.timerIds.push(window.setTimeout(()=>{var o;s===this.runToken&&(this.playing=!1,(o=t.onFinish)==null||o.call(t))},Math.max(0,h+20)))}stop(){this.runToken+=1,this.playing=!1,this.clearScheduledAudio()}clearScheduledAudio(){for(const e of this.timerIds)window.clearTimeout(e);this.timerIds=[];for(const e of this.oscillators)try{e.stop()}catch{}this.oscillators=[]}async ensureContext(){if(this.audioContext)return;const e=window.AudioContext;this.audioContext=new e}}const H=60,N=120,_=2,F=[{pitchClass:4,durationUnits:1},{pitchClass:0,durationUnits:1},{pitchClass:4,durationUnits:1},{pitchClass:0,durationUnits:1},{pitchClass:5,durationUnits:1},{pitchClass:4,durationUnits:1},{pitchClass:2,durationUnits:2},{pitchClass:7,durationUnits:1},{pitchClass:7,durationUnits:1},{pitchClass:7,durationUnits:1},{pitchClass:9,durationUnits:.5},{pitchClass:11,durationUnits:.5},{pitchClass:0,durationUnits:1},{pitchClass:0,durationUnits:1},{pitchClass:0,durationUnits:2}],$=F.map(r=>({pitchClass:r.pitchClass,durationUnits:r.durationUnits,midi:H+r.pitchClass}));function D(r,e=N){const s=60/e/_;return r*s}function z(r,e=N){let t=0;return $.map((s,i)=>{const n=s.midi+r,c=g(s.pitchClass+r,12),h=D(s.durationUnits,e),u={index:i,pitchClass:c,midi:n,durationUnits:s.durationUnits,durationSec:h,startSec:t};return t+=h,u})}const V="http://www.w3.org/2000/svg",S={0:"#ff3b30",2:"#ff9500",4:"#ffd60a",5:"#30d158",7:"#00c7be",9:"#0a84ff",11:"#5e5ce6"},q={1:[0,2],3:[2,4],6:[5,7],8:[7,9],10:[9,11]};function j(){const r=Array(12);for(const[e,t]of Object.entries(S))r[Number(e)]=t;for(const[e,t]of Object.entries(q)){const s=Number(e),[i,n]=t;r[s]=B(S[i],S[n])}return r}const R=j();function a(r){return document.createElementNS(V,r)}class K{constructor(e){this.svg=e,this.center=240,this.baseInnerRadius=94,this.baseOuterRadius=170,this.historyOuterRadius=220,this.historyThicknessPerUnit=6,this.labelRadius=235,this.sectorPaths=[],this.consumedThicknessByPitch=Array(12).fill(0),this.svg.setAttribute("viewBox","0 0 480 480");const t=a("g"),s=a("g"),i=a("g"),n=a("g"),c=a("g"),h=a("g");this.historyGroup=s,this.arrowGroup=h,this.drawBackdrop(t),this.drawSectors(i),this.drawLabels(n),this.drawCenter(c),this.drawArrow(h),this.svg.append(t,s,i,n,c,h);const u=a("text");u.setAttribute("x",String(this.center)),u.setAttribute("y",String(this.center+8)),u.setAttribute("class","center-readout"),u.textContent="C",this.centerReadout=u,this.svg.append(u),this.setTransposition(0)}setTransposition(e){const t=g(e,12),s=-t*30;this.arrowGroup.setAttribute("transform",`translate(${this.center} ${this.center}) rotate(${s})`),this.centerReadout.textContent=`C → ${x[t]}`}setActivePitchClass(e){for(const s of this.sectorPaths)s.classList.remove("sector-active");if(e===null)return;const t=g(e,12);this.sectorPaths[t].classList.add("sector-active")}addHistoryLayer(e,t){const s=g(e,12),i=Math.max(2.5,t*this.historyThicknessPerUnit),n=this.consumedThicknessByPitch[s],c=this.historyOuterRadius-n,h=this.baseOuterRadius+2;if(c<=h)return;const u=Math.max(h,c-i),[o,l]=this.getSectorBounds(s),d=a("path");d.setAttribute("d",this.buildAnnularSectorPath(u,c,o,l,16)),d.setAttribute("class","history-layer"),d.setAttribute("fill",R[s]),this.historyGroup.append(d),this.consumedThicknessByPitch[s]=this.historyOuterRadius-u}resetHistory(){this.historyGroup.replaceChildren(),this.consumedThicknessByPitch.fill(0),this.setActivePitchClass(null)}drawBackdrop(e){const t=a("circle");t.setAttribute("cx",String(this.center)),t.setAttribute("cy",String(this.center)),t.setAttribute("r",String(this.historyOuterRadius)),t.setAttribute("class","outer-guide");const s=a("circle");s.setAttribute("cx",String(this.center)),s.setAttribute("cy",String(this.center)),s.setAttribute("r",String(this.baseOuterRadius)),s.setAttribute("class","base-guide"),e.append(t,s)}drawSectors(e){for(let t=0;t<12;t+=1){const[s,i]=this.getSectorBounds(t),n=a("path");n.setAttribute("d",this.buildAnnularSectorPath(this.baseInnerRadius,this.baseOuterRadius,s,i,20)),n.setAttribute("class","note-sector"),n.setAttribute("fill",R[t]),this.sectorPaths[t]=n,e.append(n)}}drawLabels(e){for(let t=0;t<12;t+=1){const s=this.getSectorCenter(t),i=this.toCartesian(this.labelRadius,s),n=a("text");n.setAttribute("x",i.x.toFixed(2)),n.setAttribute("y",i.y.toFixed(2)),n.setAttribute("class","note-label"),n.textContent=x[t],e.append(n)}}drawCenter(e){const t=a("circle");t.setAttribute("cx",String(this.center)),t.setAttribute("cy",String(this.center)),t.setAttribute("r","72"),t.setAttribute("class","inner-circle"),e.append(t)}drawArrow(e){const t=a("line");t.setAttribute("x1","0"),t.setAttribute("y1","0"),t.setAttribute("x2","64"),t.setAttribute("y2","0"),t.setAttribute("class","arrow-shaft");const s=a("polygon");s.setAttribute("points","64,0 48,-8 48,8"),s.setAttribute("class","arrow-tip");const i=a("circle");i.setAttribute("cx","0"),i.setAttribute("cy","0"),i.setAttribute("r","6"),i.setAttribute("class","arrow-hub"),e.append(t,s,i)}getSectorCenter(e){return-e*30}getSectorBounds(e){const t=this.getSectorCenter(e);return[t-15,t+15]}buildAnnularSectorPath(e,t,s,i,n){const c=[],h=[];for(let o=0;o<=n;o+=1){const l=o/n,d=s+(i-s)*l;c.push(this.toCartesian(t,d))}for(let o=n;o>=0;o-=1){const l=o/n,d=s+(i-s)*l;h.push(this.toCartesian(e,d))}return[...c,...h].map((o,l)=>`${l===0?"M":"L"} ${o.x.toFixed(2)} ${o.y.toFixed(2)}`).join(" ")+" Z"}toCartesian(e,t){const s=t*Math.PI/180;return{x:this.center+e*Math.cos(s),y:this.center+e*Math.sin(s)}}}function A(r){const e=document.querySelector(r);if(!e)throw new Error(`UI element not found: ${r}`);return e}const b=A("#shift-input"),T=A("#play-button"),Z=A("#transpose-readout"),Y=A("#melody-visualizer"),f=new K(Y),U=new G;let C=null;function J(r){const e=Number(r);return Number.isFinite(e)?Math.trunc(e):0}function P(){return J(b.value)}function w(){const r=P(),e=g(r,12);f.setTransposition(r),Z.textContent=`Нота C после сдвига: ${x[e]}`}function Q(){b.value=String(P()),w()}async function W(){const r=P(),e=z(r);U.stop(),f.resetHistory(),T.textContent="Restart",await U.play(e,{onNoteStart(t){C=t.index,f.setActivePitchClass(t.pitchClass),f.addHistoryLayer(t.pitchClass,t.durationUnits)},onNoteEnd(t){C===t.index&&(C=null,f.setActivePitchClass(null))},onFinish(){C=null,f.setActivePitchClass(null),T.textContent="Play"}})}b.addEventListener("input",()=>{w()});b.addEventListener("blur",()=>{Q()});T.addEventListener("click",()=>{W()});w();
